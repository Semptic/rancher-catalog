version: '2'

services:
    nginx:
        image: nginx:alpine
        links:
         - nextcloud
        environment:
         CONFIG: |
             upstream php-handler {
                 server nextcloud:9000;
             }
             
             server {
                 listen 80;
             
                 #add_header Strict-Transport-Security 'max-age=15768000; includeSubDomains; preload;';
                 add_header X-Content-Type-Options nosniff;
                 add_header X-XSS-Protection '1; mode=block';
                 add_header X-Robots-Tag none;
                 add_header X-Download-Options noopen;
                 add_header X-Permitted-Cross-Domain-Policies none;
             
                 root /var/www/html;
                  
                 client_max_body_size 0;
                 fastcgi_buffers 64 8k;
             
                 # Enable gzip but do not remove ETag headers
                 gzip on;
                 gzip_vary on;
                 gzip_comp_level 4;
                 gzip_min_length 256;
                 gzip_proxied expired no-cache no-store private no_last_modified no_etag auth;
                 gzip_types application/atom+xml application/javascript application/json application/ld+json application/manifest+json application/rss+xml application/vnd.geo+json application/vnd.ms-fontobject application/x-font-ttf application/x-web-app-manifest+json application/xhtml+xml application/xml font/opentype image/bmp image/svg+xml image/x-icon text/cache-manifest text/css text/plain text/vcard text/vnd.rim.location.xloc text/vtt text/x-component text/x-cross-domain-policy;
             
                 index index.php;
                 error_page 403 /core/templates/403.php;
                 error_page 404 /core/templates/404.php;
             
                 rewrite ^/.well-known/carddav /remote.php/dav/ permanent;
                 rewrite ^/.well-known/caldav /remote.php/dav/ permanent;
             
                 location = /robots.txt {
                     allow all;
                     log_not_found off;
                     access_log off;
                 }
             
                 location / {
                     rewrite ^ /index.php$$uri;
                 }
             
                 location ~ ^/(?:build|tests|config|lib|3rdparty|templates|data)/ {
                     deny all;
                 }
                 location ~ ^/(?:\.|autotest|occ|issue|indie|db_|console) {
                     deny all;
                 }
             
                 location ~ ^/(?:index|remote|public|cron|core/ajax/update|status|ocs/v[12]|updater/.+|ocs-provider/.+)\.php(?:$$|/) {
                     fastcgi_split_path_info ^(.+\.php)(/.*)$$;
                     include fastcgi_params;
                     fastcgi_param SCRIPT_FILENAME         '$$document_root$$fastcgi_script_name';
                     fastcgi_param PATH_INFO               '$$fastcgi_path_info';
                     fastcgi_param HTTPS                   on;
                     #Avoid sending the security headers twice
                     fastcgi_param modHeadersAvailable     true;
                     fastcgi_param front_controller_active true;
                     fastcgi_pass                          php-handler;
                     fastcgi_intercept_errors              on;
                     fastcgi_request_buffering             off;
                 }
             
                 location ~ ^/(?:updater|ocs-provider)(?:$$|/) {
                     try_files $$uri/ =404;
                     index index.php;
                 }
             
                 # Adding the cache control header for js and css files
                 # Make sure it is BELOW the PHP block
                 location ~ \.(?:css|js|woff|svg|gif)$$ {
                     try_files $$uri /index.php$$uri$$is_args$$args;
                     add_header Cache-Control 'public, max-age=15778463';
                     # Add headers to serve security related headers (It is intended to
                     # have those duplicated to the ones above)
                     # Before enabling Strict-Transport-Security headers please read into
                     # this topic first.
                     # add_header Strict-Transport-Security 'max-age=15768000; includeSubDomains; preload;';
                     #
                     # WARNING: Only add the preload option once you read about
                     # the consequences in https://hstspreload.org/. This option
                     # will add the domain to a hardcoded list that is shipped
                     # in all major browsers and getting removed from this list
                     # could take several months.
                     add_header X-Content-Type-Options nosniff;
                     add_header X-XSS-Protection '1; mode=block';
                     add_header X-Robots-Tag none;
                     add_header X-Download-Options noopen;
                     add_header X-Permitted-Cross-Domain-Policies none;
                     # Optional: Don't log access to assets
                     access_log off;
                 }
             
                 location ~ \.(?:png|html|ttf|ico|jpg|jpeg)$$ {
                     try_files $$uri /index.php$$uri$$is_args$$args;
                     # Optional: Don't log access to other assets
                     access_log off;
                 }
             }

        command: /bin/sh -c "echo \"$$CONFIG\" > /etc/nginx/conf.d/default.conf && nginx -g 'daemon off;'"
    nextcloud:
        image: nextcloud:fpm
        links:
         - nextcloud-db
        environment:
          AUTOCONFIG: |
              <?php
                $$AUTOCONFIG = array(
                  "dbtype"        => "pgsql",
                  "dbname"        => "${POSTGRES_DB}",
                  "dbuser"        => "${DB_USER}",
                  "dbpass"        => "${DB_PASS}",
                  "dbhost"        => "nextcloud-db",
                  "adminlogin"    => "${ADMIN}",
                  "adminpass"     => "${ADMIN_PASS}",
                );
        volumes:
         - nextcloud_apps:/var/www/html/custom_apps
         - nextcloud_config:/var/www/html/config
         - nextcloud_data:/var/www/html/data
        entrypoint: "/bin/sh -c "
        command: '[ -f /var/www/html/config/config.php ] || echo "$$AUTOCONFIG" > /var/www/html/config/autoconfig.php; /entrypoint.sh php-fmp'
    nextcloud-db:
        image: postgres:alpine
        environment:
         - POSTGRES_PASSWORD=${DB_PASS}
         - POSTGRES_USER=${DB_USER}
         - POSTGRES_DB=${POSTGRES_DB}
        volumes:
         - nextcloud-db_data:/var/lib/postgresql/data/

volumes:
    nextcloud_apps:
        driver: convoy
    nextcloud_config:
        driver: convoy
    nextcloud_data:
        driver: convoy
    nextcloud-db_data:
        driver: convoy
